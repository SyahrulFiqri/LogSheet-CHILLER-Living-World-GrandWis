<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGSHEET CHILLER PLAN - Mall Living World Grand Wisata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .logsheet-table { font-size: 11px; }
        .parameter-cell { min-width: 150px; }
        .unit-cell { min-width: 80px; }
        .value-cell { min-width: 60px; text-align: center; }
        .time-header { font-weight: bold; background: #f3f4f6; }
        .section-header { background: #e5e7eb; font-weight: bold; }
        .out-of-range { background-color: #fef2f2; color: #dc2626; font-weight: bold; }
        .in-range { background-color: #f0fdf4; color: #166534; }
        .pulse-save { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @media print {
            .no-print { display: none; }
            body { font-size: 9px; }
            .logsheet-table { font-size: 8px; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-bg text-white p-6 mb-6 no-print">
        <div class="max-w-7xl mx-auto text-center">
            <h1 class="text-3xl font-bold mb-2">‚ùÑÔ∏è LOGSHEET CHILLER PLAN</h1>
            <h2 class="text-xl font-semibold mb-1">MALL LIVING WORLD GRAND WISATA</h2>
            <p class="text-blue-100">Sistem Monitoring & Pelaporan Data Chiller - Advanced Version 2.0</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4">
        <!-- Control Panel -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-6 no-print">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="dateSelect" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" value="2025-01-15" onchange="updateDateDisplay()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                        <select id="unitSelect" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="all">Semua Unit</option>
                            <option value="unit1">Unit No.1</option>
                            <option value="unit2">Unit No.2</option>
                            <option value="unit3">Unit No.3</option>
                        </select>
                    </div>
                    <div class="text-xs text-gray-600">
                        <div>üíæ Auto-save: <span id="autoSaveStatus" class="text-green-600">Aktif</span></div>
                        <div>üïí Last save: <span id="lastSaveTime">-</span></div>
                    </div>
                </div>
                
                <!-- Main Action Buttons -->
                <div class="flex gap-2 flex-wrap">
                    <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-medium transition-colors text-sm">
                        üîÑ Refresh
                    </button>
                    <button onclick="quickInputMode()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg font-medium transition-colors text-sm">
                        ‚ö° Input Cepat
                    </button>
                    <button onclick="inputData()" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg font-medium transition-colors text-sm">
                        ‚úèÔ∏è Input Data
                    </button>
                </div>
            </div>
            
            <!-- Advanced Features Row -->
            <div class="border-t pt-4 mt-4">
                <div class="flex flex-wrap gap-2">
                    <div class="flex gap-2">
                        <span class="text-sm font-medium text-gray-700 self-center">üìä Export:</span>
                       <button onclick="exportLogsheet()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            üìä Export Excel
                        </button>
                        <button onclick="exportMonthlyLogsheet()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            üìÜ Export Bulanan
                        </button>

                        <button onclick="generateDailyReport()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                            üìã Laporan
                        </button>
                        <button onclick="printLogsheet()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                            üñ®Ô∏è Print
                        </button>
                    </div>
                    
                    <div class="flex gap-2 ml-4">
                        <span class="text-sm font-medium text-gray-700 self-center">üíæ Data:</span>
                        <button onclick="backupAllData()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
                            üì¶ Backup
                        </button>
                        <button onclick="importBackupData()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded text-sm">
                            üì• Import
                        </button>
                        <button onclick="copyFromPreviousDay()" class="bg-pink-600 hover:bg-pink-700 text-white px-3 py-1 rounded text-sm">
                            üìã Copy Kemarin
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 no-print">
            <div class="bg-white rounded-lg card-shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Unit Beroperasi</p>
                        <p class="text-2xl font-bold text-green-600" id="operatingUnits">3</p>
                    </div>
                    <div class="bg-green-100 p-2 rounded-full">
                        <span class="text-xl">‚úÖ</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg card-shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Data Lengkap</p>
                        <p class="text-2xl font-bold text-blue-600" id="completionRate">89%</p>
                    </div>
                    <div class="bg-blue-100 p-2 rounded-full">
                        <span class="text-xl">üìä</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg card-shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Perlu Perhatian</p>
                        <p class="text-2xl font-bold text-yellow-600" id="warningParams">7</p>
                    </div>
                    <div class="bg-yellow-100 p-2 rounded-full">
                        <span class="text-xl">‚ö†Ô∏è</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg card-shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Avg Load</p>
                        <p class="text-2xl font-bold text-purple-600" id="avgLoad">96.2%</p>
                    </div>
                    <div class="bg-purple-100 p-2 rounded-full">
                        <span class="text-xl">‚ö°</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg card-shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Status Sistem</p>
                        <p class="text-sm font-bold text-green-600" id="systemStatus">üü¢ Normal</p>
                    </div>
                    <div class="bg-green-100 p-2 rounded-full">
                        <span class="text-xl">üîß</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Logsheet Table -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">üìã LOGSHEET CHILLER PLAN</h3>
                    <p class="text-sm text-gray-600">Tanggal: <span id="currentDate">15 Januari 2025</span></p>
                </div>
                <div class="text-right text-sm text-gray-600 no-print">
                    <p>Last Update: <span id="lastUpdate">15:30 WIB</span></p>
                    <p class="text-xs">Version 2.0 - Advanced Features</p>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300 logsheet-table">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 p-2 text-center">No</th>
                            <th class="border border-gray-300 p-2 text-center parameter-cell">Description</th>
                            <th class="border border-gray-300 p-2 text-center">Parameter</th>
                            <th class="border border-gray-300 p-2 text-center unit-cell">Unit</th>
                            <th class="border border-gray-300 p-2 text-center time-header" colspan="5">Unit No.1</th>
                            <th class="border border-gray-300 p-2 text-center time-header" colspan="5">Unit No.2</th>
                            <th class="border border-gray-300 p-2 text-center time-header" colspan="5">Unit No.3</th>
                            <th class="border border-gray-300 p-2 text-center">Keterangan</th>
                        </tr>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-300 p-1"></th>
                            <th class="border border-gray-300 p-1"></th>
                            <th class="border border-gray-300 p-1"></th>
                            <th class="border border-gray-300 p-1"></th>
                            <th class="border border-gray-300 p-1 text-xs">09:30</th>
                            <th class="border border-gray-300 p-1 text-xs">12:00</th>
                            <th class="border border-gray-300 p-1 text-xs">15:00</th>
                            <th class="border border-gray-300 p-1 text-xs">18:00</th>
                            <th class="border border-gray-300 p-1 text-xs">21:00</th>
                            <th class="border border-gray-300 p-1 text-xs">09:30</th>
                            <th class="border border-gray-300 p-1 text-xs">12:00</th>
                            <th class="border border-gray-300 p-1 text-xs">15:00</th>
                            <th class="border border-gray-300 p-1 text-xs">18:00</th>
                            <th class="border border-gray-300 p-1 text-xs">21:00</th>
                            <th class="border border-gray-300 p-1 text-xs">09:30</th>
                            <th class="border border-gray-300 p-1 text-xs">12:00</th>
                            <th class="border border-gray-300 p-1 text-xs">15:00</th>
                            <th class="border border-gray-300 p-1 text-xs">18:00</th>
                            <th class="border border-gray-300 p-1 text-xs">21:00</th>
                            <th class="border border-gray-300 p-1"></th>
                        </tr>
                    </thead>
                    <tbody id="logsheetTableBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Signature Section -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">üë• Tanda Tangan Petugas</h3>
            <div class="grid grid-cols-1 md:grid-cols-7 gap-4 text-center">
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Dibuat Oleh</p>
                    <input type="text" id="supervisor" placeholder="Nama Supervisor" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-12 mb-2 border-t border-gray-200 pt-2">
                        <input type="text" id="supervisorSignature" placeholder="Tanda tangan digital" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                    <p class="text-xs font-medium">Spv. Engineering</p>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Pic Logsheet</p>
                    <p class="text-xs mb-1 font-medium">09:30</p>
                    <input type="text" id="staff0930" placeholder="Nama Petugas" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-8 mb-2 border-t border-gray-200 pt-1">
                        <input type="text" id="signature0930" placeholder="TTD" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-1 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Pic Logsheet</p>
                    <p class="text-xs mb-1 font-medium">12:00</p>
                    <input type="text" id="staff1200" placeholder="Nama Petugas" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-8 mb-2 border-t border-gray-200 pt-1">
                        <input type="text" id="signature1200" placeholder="TTD" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-1 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Pic Logsheet</p>
                    <p class="text-xs mb-1 font-medium">15:00</p>
                    <input type="text" id="staff1500" placeholder="Nama Petugas" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-8 mb-2 border-t border-gray-200 pt-1">
                        <input type="text" id="signature1500" placeholder="TTD" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-1 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Pic Logsheet</p>
                    <p class="text-xs mb-1 font-medium">18:00</p>
                    <input type="text" id="staff1800" placeholder="Nama Petugas" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-8 mb-2 border-t border-gray-200 pt-1">
                        <input type="text" id="signature1800" placeholder="TTD" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-1 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Pic Logsheet</p>
                    <p class="text-xs mb-1 font-medium">21:00</p>
                    <input type="text" id="staff2100" placeholder="Nama Petugas" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-8 mb-2 border-t border-gray-200 pt-1">
                        <input type="text" id="signature2100" placeholder="TTD" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-1 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Mengetahui</p>
                    <input type="text" id="manager" placeholder="Nama Manager" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-12 mb-2 border-t border-gray-200 pt-2">
                        <input type="text" id="managerSignature" placeholder="Tanda tangan digital" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                    <p class="text-xs font-medium">Manager Engineering</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Data Modal -->
    <div id="inputModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Input Data Parameter</h3>
                    <button onclick="closeInputModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
                <form id="inputForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Parameter</label>
                            <select id="parameterSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="">Pilih Parameter</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Unit</label>
                            <select id="unitInput" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="unit1">Unit No.1</option>
                                <option value="unit2">Unit No.2</option>
                                <option value="unit3">Unit No.3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Waktu</label>
                            <select id="timeInput" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="0930">09:30</option>
                                <option value="1200">12:00</option>
                                <option value="1500">15:00</option>
                                <option value="1800">18:00</option>
                                <option value="2100">21:00</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Nilai</label>
                            <input type="number" step="0.1" id="valueInput" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Masukkan nilai">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeInputModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg">Batal</button>
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Input Modal -->
    <div id="quickInputModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-6xl w-full p-6 max-h-screen overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold">‚ö° Mode Input Cepat</h3>
                        <p class="text-sm text-gray-600">Klik langsung pada sel untuk mengedit nilai</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div>
                            <label class="block text-xs font-medium mb-1">Unit</label>
                            <select id="quickUnitSelect" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                <option value="unit1">Unit No.1</option>
                                <option value="unit2">Unit No.2</option>
                                <option value="unit3">Unit No.3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Waktu</label>
                            <select id="quickTimeSelect" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                <option value="0930">09:30</option>
                                <option value="1200">12:00</option>
                                <option value="1500">15:00</option>
                                <option value="1800">18:00</option>
                                <option value="2100">21:00</option>
                            </select>
                        </div>
                        <button onclick="closeQuickInputModal()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg mb-4">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs">Tips:</span>
                        <span>Pilih Unit dan Waktu di atas, lalu klik nilai yang ingin diubah. Tekan Enter untuk simpan atau Esc untuk batal.</span>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 text-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-2">No</th>
                                <th class="border border-gray-300 p-2 min-w-48">Parameter</th>
                                <th class="border border-gray-300 p-2">Unit</th>
                                <th class="border border-gray-300 p-2">Range</th>
                                <th class="border border-gray-300 p-2">Nilai Saat Ini</th>
                                <th class="border border-gray-300 p-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="quickInputTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-between items-center mt-6">
                    <div class="text-sm text-gray-600">
                        <span class="inline-block w-4 h-4 bg-green-100 border mr-1"></span> Normal
                        <span class="inline-block w-4 h-4 bg-red-100 border mr-1 ml-3"></span> Di luar range
                        <span class="inline-block w-4 h-4 bg-gray-100 border mr-1 ml-3"></span> Belum diisi
                    </div>
                    <div class="flex gap-3">
                        <button onclick="saveAllQuickInput()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            üíæ Simpan Semua
                        </button>
                        <button onclick="closeQuickInputModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            Tutup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Logsheet data structure with exact sequential numbering from Excel
        const logsheetData = [
            // Condenser Status (1-5)
            { no: 1, section: 'Condenser status', description: 'Condenser status', parameter: 'Water In Temp.', unit: '¬∞C', range: '27-31¬∞C', 
              unit1: { '0930': 29.7, '1200': 29.4, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 29.8, '1200': 29.4, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 29.7, '1200': 29.4, '1500': '', '1800': '', '2100': '' } },
            { no: 2, section: '', description: '', parameter: 'Water Out Temp.', unit: '¬∞C', range: '32-36¬∞C',
              unit1: { '0930': 34.4, '1200': 35.1, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 34.4, '1200': 34.6, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 34.4, '1200': 34.9, '1500': '', '1800': '', '2100': '' } },
            { no: 3, section: '', description: '', parameter: 'Condenser Approach', unit: '¬∞C', range: '<3.3¬∞C',
              unit1: { '0930': 1.7, '1200': 1.6, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 1.3, '1200': 1.0, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 0.8, '1200': 0.5, '1500': '', '1800': '', '2100': '' } },
            { no: 4, section: '', description: '', parameter: 'Condenser Pressure', unit: 'Kpa', range: 'Low: >-30 kPa, High: <187 kPa',
              unit1: { '0930': 88.2, '1200': 89.9, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 84.2, '1200': 84.2, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 81.7, '1200': 82.9, '1500': '', '1800': '', '2100': '' } },
            { no: 5, section: '', description: '', parameter: 'Condenser Saturated Temp.', unit: '¬∞C', range: '30-36¬∞C',
              unit1: { '0930': 36.3, '1200': 36.6, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 35.6, '1200': 35.6, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 35.2, '1200': 35.4, '1500': '', '1800': '', '2100': '' } },
            
            // Evaporator Status (9-14)
            { no: 9, section: 'Evaporator Status', description: 'Evaporator Status', parameter: 'Water In Temp.', unit: '¬∞C', range: '10-13¬∞C',
              unit1: { '0930': 18.2, '1200': 14.0, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 18.0, '1200': 14.0, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 17.7, '1200': 13.9, '1500': '', '1800': '', '2100': '' } },
            { no: 10, section: '', description: '', parameter: 'Water Out Temp.', unit: '¬∞C', range: '6-10¬∞C',
              unit1: { '0930': 12.4, '1200': 7.9, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 12.4, '1200': 7.9, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 12.4, '1200': 7.9, '1500': '', '1800': '', '2100': '' } },
            { no: 11, section: '', description: '', parameter: 'Evaporator Approach', unit: '¬∞C', range: '<2.2¬∞C',
              unit1: { '0930': 0.1, '1200': 0.1, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 0.1, '1200': 0.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 0.1, '1200': 0.1, '1500': '', '1800': '', '2100': '' } },
            { no: 12, section: '', description: '', parameter: 'Evaporator Pressure', unit: 'Kpa', range: 'Low: >-47 kPa, High: <187 kPa',
              unit1: { '0930': -30.4, '1200': -38.2, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': -27.8, '1200': -36.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': -34.4, '1200': -40.0, '1500': '', '1800': '', '2100': '' } },
            { no: 13, section: '', description: '', parameter: 'Evap Saturated Refrig Temp', unit: '¬∞C', range: 'Low: >2.2¬∞C, High: <15¬∞C',
              unit1: { '0930': 9.1, '1200': 6.2, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 10.0, '1200': 7.0, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 7.7, '1200': 5.5, '1500': '', '1800': '', '2100': '' } },
            { no: 14, section: '', description: '', parameter: 'Evap Refrig Liquid Temp.', unit: '¬∞C', range: '7-10¬∞C',
              unit1: { '0930': 13.5, '1200': 8.6, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 13.9, '1200': 8.9, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 13.4, '1200': 8.7, '1500': '', '1800': '', '2100': '' } },
            
            // Compressor Status (19-26)
            { no: 19, section: 'Compressor Status', description: 'Compressor Status', parameter: 'Compressor Running Hour', unit: 'Hours', range: 'Actual',
              unit1: { '0930': 1287.4, '1200': 1280.5, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 1279.1, '1200': 1281.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 1278.8, '1200': 1280.8, '1500': '', '1800': '', '2100': '' } },
            { no: 20, section: '', description: '', parameter: 'Compressor Starts Number', unit: '', range: 'Actual',
              unit1: { '0930': 141.0, '1200': 141.0, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 147.0, '1200': 147.0, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 140.0, '1200': 140.0, '1500': '', '1800': '', '2100': '' } },
            { no: 21, section: '', description: '', parameter: 'Comp. Discharge Temp.', unit: '¬∞C', range: '<50¬∞C',
              unit1: { '0930': 39.6, '1200': 38.9, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 39.9, '1200': 38.6, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 40.3, '1200': 38.3, '1500': '', '1800': '', '2100': '' } },
            { no: 24, section: '', description: '', parameter: 'Discharge Superheat', unit: '¬∞C', range: '<8¬∞C',
              unit1: { '0930': 3.4, '1200': 2.4, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 4.2, '1200': 2.9, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 5.1, '1200': 2.9, '1500': '', '1800': '', '2100': '' } },
            { no: 25, section: '', description: '', parameter: 'Actual GV1 Position', unit: '%', range: '0-93',
              unit1: { '0930': 92.8, '1200': 86.5, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 93.4, '1200': 93.4, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 93.5, '1200': 79.2, '1500': '', '1800': '', '2100': '' } },
            { no: 26, section: '', description: '', parameter: 'Actual GV2 Position', unit: '%', range: '0-93',
              unit1: { '0930': 93.2, '1200': 90.6, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 93.5, '1200': 93.4, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 93.5, '1200': 87.8, '1500': '', '1800': '', '2100': '' } },
            
            // Motor Status (27-30)
            { no: 27, section: 'Motor Status', description: 'Motor Status', parameter: 'Motor Killowatts', unit: 'KW', range: 'Actual',
              unit1: { '0930': 288.1, '1200': 296.4, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 287.3, '1200': 284.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 291.8, '1200': 279.2, '1500': '', '1800': '', '2100': '' } },
            { no: 28, section: '', description: '', parameter: 'Motor current', unit: 'AMPS', range: 'Actual',
              unit1: { '0930': 572.3, '1200': 561.3, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 570.9, '1200': 547.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 575.5, '1200': 533.4, '1500': '', '1800': '', '2100': '' } },
            { no: 29, section: '', description: '', parameter: 'Percent Load Current', unit: '%', range: 'Actual',
              unit1: { '0930': 99.5, '1200': 97.6, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 99.3, '1200': 95.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 100.1, '1200': 92.8, '1500': '', '1800': '', '2100': '' } },
            { no: 30, section: '', description: '', parameter: 'Motor Winding 1 temp', unit: '¬∞C', range: '<100¬∞C',
              unit1: { '0930': 35.9, '1200': 31.0, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 26.5, '1200': 24.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 30.4, '1200': 25.3, '1500': '', '1800': '', '2100': '' } },
            
            // VFD Status (31-35)
            { no: 31, section: 'VFD Status', description: 'VFD Status', parameter: 'Actual Line Voltage', unit: 'Volts', range: 'Actual',
              unit1: { '0930': 381.9, '1200': 383.6, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 382.6, '1200': 387.0, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 383.6, '1200': 387.4, '1500': '', '1800': '', '2100': '' } },
            { no: 32, section: '', description: '', parameter: 'Actual Vfd Freq', unit: 'Hz', range: 'Actual',
              unit1: { '0930': 78.7, '1200': 82.4, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 78.6, '1200': 80.9, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 79.6, '1200': 81.7, '1500': '', '1800': '', '2100': '' } },
            { no: 33, section: '', description: '', parameter: 'Actual Vfd Speed', unit: '%', range: 'Actual',
              unit1: { '0930': 96.3, '1200': 100.8, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 96.2, '1200': 99.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 97.4, '1200': 100.0, '1500': '', '1800': '', '2100': '' } },
            { no: 34, section: '', description: '', parameter: 'Actual Line Current', unit: 'AMPS', range: 'Actual',
              unit1: { '0930': 499.7, '1200': 501.6, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 693.7, '1200': 487.8, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 505.9, '1200': 477.1, '1500': '', '1800': '', '2100': '' } },
            { no: 35, section: '', description: '', parameter: 'Vfd Load Current', unit: 'AMPS', range: 'Actual',
              unit1: { '0930': 567.3, '1200': 556.9, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 567.9, '1200': 545.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 568.0, '1200': 530.4, '1500': '', '1800': '', '2100': '' } },
            
            // Purge System (36-38)
            { no: 36, section: 'Purge Syst.', description: 'Purge Syst.', parameter: 'Total Pumpout Number', unit: '', range: 'Actual',
              unit1: { '0930': 7.0, '1200': 7.0, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 9.0, '1200': 9.0, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 19.0, '1200': 19.0, '1500': '', '1800': '', '2100': '' } },
            { no: 37, section: '', description: '', parameter: 'Purge Comp.Suction Temp.', unit: '¬∞C', range: '-25-30¬∞C',
              unit1: { '0930': 23.0, '1200': 20.1, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 33.1, '1200': 34.0, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 11.3, '1200': 5.3, '1500': '', '1800': '', '2100': '' } },
            { no: 38, section: '', description: '', parameter: 'Purge Inlet Temp.', unit: '¬∞C', range: '<38¬∞C',
              unit1: { '0930': 36.3, '1200': 36.6, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 35.6, '1200': 35.8, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 35.2, '1200': 35.4, '1500': '', '1800': '', '2100': '' } },
            
            // Lubrication (39-46)
            { no: 39, section: 'Lubrication', description: 'Lubrication', parameter: 'Bearing Ref. Suplay Sat. Temp.', unit: '¬∞C', range: '30-60¬∞C',
              unit1: { '0930': 45.5, '1200': 45.6, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 43.1, '1200': 43.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 50.9, '1200': 51.2, '1500': '', '1800': '', '2100': '' } },
            { no: 40, section: '', description: '', parameter: '1st Stage Bearing Temp.', unit: '¬∞C', range: '40-50¬∞C',
              unit1: { '0930': 21.3, '1200': 19.9, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 18.6, '1200': 16.9, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 14.6, '1200': 12.5, '1500': '', '1800': '', '2100': '' } },
            { no: 41, section: '', description: '', parameter: '2nd Stage Bearing Temp.', unit: '¬∞C', range: '40-50¬∞C',
              unit1: { '0930': 28.2, '1200': 27.3, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 27.0, '1200': 26.3, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 27.7, '1200': 27.1, '1500': '', '1800': '', '2100': '' } },
            { no: 42, section: '', description: '', parameter: 'Bearing Inlet Pressure', unit: 'Kpa', range: '60-180 kPa',
              unit1: { '0930': 153.0, '1200': 152.9, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 135.2, '1200': 134.2, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 199.1, '1200': 202.3, '1500': '', '1800': '', '2100': '' } },
            { no: 43, section: '', description: '', parameter: 'Bearing Outlet pressure', unit: 'Kpa', range: '3 - (-40) kPa',
              unit1: { '0930': -17.9, '1200': -25.6, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': -19.7, '1200': -25.4, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 25.7, '1200': -30.4, '1500': '', '1800': '', '2100': '' } },
            { no: 44, section: '', description: '', parameter: 'Pump Inlet Pressure', unit: 'Kpa', range: '>80 kPa',
              unit1: { '0930': 94.8, '1200': 96.0, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 94.7, '1200': 96.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 92.9, '1200': 91.8, '1500': '', '1800': '', '2100': '' } },
            { no: 45, section: '', description: '', parameter: 'Pump Outlet Pressure', unit: 'Kpa', range: '>100 kPa',
              unit1: { '0930': 195.0, '1200': 194.7, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 168.8, '1200': 168.1, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 248.8, '1200': 249.2, '1500': '', '1800': '', '2100': '' } },
            { no: 46, section: '', description: '', parameter: 'Ref Pump Amps', unit: 'Amps', range: '1.0-3.0',
              unit1: { '0930': 100.2, '1200': 98.8, '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 74.1, '1200': 71.9, '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 155.9, '1200': 157.4, '1500': '', '1800': '', '2100': '' } },
            
            // Running Status (47-52)
            { no: 47, section: 'Running Status', description: 'Running Status', parameter: 'Setpoint Chiller', unit: '¬∞C', range: 'Actual',
              unit1: { '0930': 8.0, '1200': 8.0, '1500': 8.0, '1800': 8.0, '2100': 8.0 },
              unit2: { '0930': 8.0, '1200': 8.0, '1500': 8.0, '1800': 8.0, '2100': 8.0 },
              unit3: { '0930': 8.0, '1200': 8.0, '1500': 8.0, '1800': 8.0, '2100': 8.0 } },
            { no: 48, section: '', description: '', parameter: 'Fan Cooling Tower', unit: 'Unit', range: 'Actual',
              unit1: { '0930': 4, '1200': 4, '1500': 4, '1800': 4, '2100': 4 },
              unit2: { '0930': 4, '1200': 4, '1500': 4, '1800': 4, '2100': 4 },
              unit3: { '0930': 4, '1200': 4, '1500': 4, '1800': 4, '2100': 4 } },
            { no: 49, section: '', description: '', parameter: 'Freq CWP', unit: 'Hz', range: 'Actual',
              unit1: { '0930': '', '1200': '', '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': '', '1200': '', '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': '', '1200': '', '1500': '', '1800': '', '2100': '' } },
            { no: 50, section: '', description: '', parameter: 'Freq CHWP', unit: 'Hz', range: 'Actual',
              unit1: { '0930': '', '1200': '', '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': '', '1200': '', '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': '', '1200': '', '1500': '', '1800': '', '2100': '' } },
            { no: 51, section: '', description: '', parameter: 'Doshing Pump CT', unit: 'Unit', range: 'Actual',
              unit1: { '0930': 1, '1200': '', '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': 1, '1200': '', '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': 1, '1200': '', '1500': '', '1800': '', '2100': '' } },
            { no: 52, section: '', description: '', parameter: 'Doshing Pump Chiller', unit: 'Unit', range: 'Actual',
              unit1: { '0930': '', '1200': '', '1500': '', '1800': '', '2100': '' },
              unit2: { '0930': '', '1200': '', '1500': '', '1800': '', '2100': '' },
              unit3: { '0930': '', '1200': '', '1500': '', '1800': '', '2100': '' } }
        ];

// ==================== GENERATE UNIT CELLS ====================
function generateUnitCells(unitData, range, unit, unitKey, rowNo) {
    const times = ['0930', '1200', '1500', '1800', '2100'];
    return times.map(time => {
        const value = unitData[time];
        const displayValue = value !== '' ? value : '';
        const cellClass = validateValue(value, range, unit)
            ? 'in-range'
            : (value !== '' ? 'out-of-range' : '');
        return `
            <td class="border border-gray-300 p-1 text-center value-cell ${cellClass}">
                <input 
                    type="number" 
                    step="0.1"
                    value="${displayValue ?? ''}"
                    onchange="updateValue(${rowNo}, '${unitKey}', '${time}', this.value)"
                    class="w-16 text-center border rounded px-1 py-0.5 text-xs"
                >
            </td>`;
    }).join('');
}

// ==================== VALIDASI RANGE ====================
function validateValue(value, range, unit) {
    if (value === '' || range === 'Actual') return true;
    const num = parseFloat(value);
    if (isNaN(num)) return true;

    if (range.includes('-')) {
        const [min, max] = range.replace(/[¬∞C|kPa|%]/g, '').split('-').map(parseFloat);
        return num >= min && num <= max;
    }
    if (range.includes('<')) {
        const max = parseFloat(range.replace(/[<¬∞C|kPa|%]/g, ''));
        return num < max;
    }
    if (range.includes('>')) {
        const min = parseFloat(range.replace(/[>¬∞C|kPa|%]/g, ''));
        return num > min;
    }
    return true;
}
        
// ==================== PARAMETER SELECT MODAL ====================
function populateParameterSelect() {
    const select = document.getElementById('parameterSelect');
    if (!select) return;
    select.innerHTML = '<option value="">Pilih Parameter</option>';
    logsheetData.forEach(item => {
        if (item.parameter) {
            const opt = document.createElement('option');
            opt.value = item.no;
            opt.textContent = `${item.no}. ${item.parameter}`;
            select.appendChild(opt);
        }
    });
}

// ==================== STAFF DATA ====================
let staffData = {
    '0930': '', '1200': '', '1500': '', '1800': '', '2100': '',
    supervisor: '', manager: '',
    signature0930: '', signature1200: '', signature1500: '', signature1800: '', signature2100: '',
    supervisorSignature: '', managerSignature: ''
};

function saveStaffData() {
    const date = document.getElementById('dateSelect').value;
    staffData = {
        '0930': document.getElementById('staff0930').value,
        '1200': document.getElementById('staff1200').value,
        '1500': document.getElementById('staff1500').value,
        '1800': document.getElementById('staff1800').value,
        '2100': document.getElementById('staff2100').value,
        supervisor: document.getElementById('supervisor').value,
        manager: document.getElementById('manager').value,
        signature0930: document.getElementById('signature0930').value,
        signature1200: document.getElementById('signature1200').value,
        signature1500: document.getElementById('signature1500').value,
        signature1800: document.getElementById('signature1800').value,
        signature2100: document.getElementById('signature2100').value,
        supervisorSignature: document.getElementById('supervisorSignature').value,
        managerSignature: document.getElementById('managerSignature').value
    };
    localStorage.setItem(`staff_data_${date}`, JSON.stringify(staffData));
}

function loadStaffData(date) {
    const data = JSON.parse(localStorage.getItem(`staff_data_${date}`) || 'null');
    if (data) {
        Object.keys(data).forEach(k => {
            const el = document.getElementById(k);
            if (el) el.value = data[k];
        });
        staffData = data;
    }
}

// ==================== TANGGAL DAN INISIALISASI ====================
function updateDateTime() {
    const now = new Date();
    document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', {
        day: 'numeric', month: 'long', year: 'numeric'
    });
    document.getElementById('lastUpdate').textContent =
        now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) + ' WIB';
}

function initializeLogsheet() {
    populateLogsheetTable();
    populateParameterSelect();
    updateDateTime();
    updateStatistics();
    loadStaffData(document.getElementById('dateSelect').value);
}

window.addEventListener('DOMContentLoaded', initializeLogsheet);
</script>

       <script>
/* ===========================
   Helper: Notification toast
   =========================== */
function showNotification(message, type = 'info', timeout = 2500) {
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.position = 'fixed';
        container.style.right = '16px';
        container.style.top = '16px';
        container.style.zIndex = 9999;
        document.body.appendChild(container);
    }
    const el = document.createElement('div');
    el.textContent = message;
    el.style.marginTop = '8px';
    el.style.padding = '10px 14px';
    el.style.borderRadius = '8px';
    el.style.color = '#fff';
    el.style.fontSize = '13px';
    el.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
    if (type === 'success') el.style.background = '#16a34a';
    else if (type === 'error') el.style.background = '#dc2626';
    else if (type === 'warning') el.style.background = '#d97706';
    else el.style.background = '#0ea5e9';
    container.appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; setTimeout(()=>el.remove(),400); }, timeout);
}

/* ===========================
   populate / render table
   - Uses tbody id="logsheetTableBody"
   - Creates inputs that call updateValue(...)
   =========================== */
function populateLogsheetTable() {
    const tbody = document.getElementById('logsheetTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    logsheetData.forEach(item => {
        const tr = document.createElement('tr');
        // Section header styling if description equals section (you used this pattern)
        const isSection = item.section && item.description === item.section;
        if (isSection) tr.className = 'bg-gray-100 font-semibold';

        // Build cells
        const noTd = `<td class="border border-gray-300 p-2 text-center">${item.no}</td>`;
        const descTd = `<td class="border border-gray-300 p-2 ${isSection ? 'font-bold' : ''}">${item.description || ''}</td>`;
        const paramTd = `<td class="border border-gray-300 p-2">${item.parameter || ''}</td>`;
        const unitTd = `<td class="border border-gray-300 p-2 text-center">${item.unit || ''}</td>`;

        // unit cells (3 units x 5 times)
        const times = ['0930','1200','1500','1800','2100'];
        function unitCells(unitKey) {
            return times.map(t => {
                const value = item[unitKey]?.[t] ?? '';
                const display = value !== '' ? value : '';
                // input value uses item.no as identifier for updateValue
                return `
                    <td class="border border-gray-300 p-1 text-center value-cell">
                        <input type="number" step="0.1" 
                            value="${display}" 
                            onchange="updateValue(${item.no}, '${unitKey}', '${t}', this.value)"
                            class="w-16 text-center border rounded px-1 py-0.5 text-xs">
                    </td>`;
            }).join('');
        }

        tr.innerHTML = noTd + descTd + paramTd + unitTd +
                       unitCells('unit1') + unitCells('unit2') + unitCells('unit3') +
                       `<td class="border border-gray-300 p-2 text-center text-xs"></td>`;

        tbody.appendChild(tr);
    });
}

/* ===========================
   Update value & save
   - rowNo matches item.no
   - saves to storage (with metadata)
   - updates statistics & UI
   =========================== */
function updateValue(rowNo, unitKey, time, value) {
    const idx = logsheetData.findIndex(i => i.no === rowNo);
    if (idx === -1) return;
    // normalize empty
    logsheetData[idx][unitKey][time] = (value === '' ? '' : (isNaN(value) ? value : parseFloat(value)));
    saveDataToStorage(); // persist
    updateStatistics();
    // update cell coloring: done on next populate; but we can update immediate by re-populating row
    // simpler: re-populate table (fast enough)
    populateLogsheetTable();
}

/* ===========================
   Save to localStorage (new format with metadata)
   =========================== */
function saveDataToStorage() {
    const currentDate = document.getElementById('dateSelect').value;
    const storageKey = `logsheet_chiller_${currentDate}`;
    const saveTime = new Date().toISOString();

    const dataToSave = {
        version: '2.0',
        timestamp: saveTime,
        date: currentDate,
        data: logsheetData,
        metadata: {
            lastModified: saveTime,
            facility: 'Mall Living World Grand Wisata'
        }
    };

    localStorage.setItem(storageKey, JSON.stringify(dataToSave));
    localStorage.setItem('logsheet_last_save', saveTime);

    const lastSaveEl = document.getElementById('lastSaveTime');
    if (lastSaveEl) {
        lastSaveEl.textContent = new Date(saveTime).toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });
    }

    const saveStatus = document.getElementById('autoSaveStatus');
    if (saveStatus) {
        saveStatus.textContent = 'Tersimpan';
        saveStatus.className = 'text-green-600 pulse-save';
        setTimeout(()=> { saveStatus.className = 'text-green-600'; }, 2000);
    }
}

/* ===========================
   Load data for date
   - supports old format (raw array) and new { data: [...] }
   =========================== */
function loadDataForDate(date) {
    if (!date) return;
    const storageKey = `logsheet_chiller_${date}`;
    const saved = localStorage.getItem(storageKey);
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            const dataArray = parsed.data || parsed;
            // update only unit fields (keep other properties)
            dataArray.forEach((savedItem, i) => {
                if (logsheetData[i]) {
                    if (savedItem.unit1) logsheetData[i].unit1 = savedItem.unit1;
                    if (savedItem.unit2) logsheetData[i].unit2 = savedItem.unit2;
                    if (savedItem.unit3) logsheetData[i].unit3 = savedItem.unit3;
                }
            });
            populateLogsheetTable();
            updateStatistics();
            showNotification(`Data untuk ${date} berhasil dimuat!`, 'success');
        } catch (e) {
            console.error(e);
            showNotification('Error loading data for this date', 'error');
        }
    } else {
        resetToDefaultValues();
        populateLogsheetTable();
        updateStatistics();
    }
}

/* ===========================
   Reset units to default '' (except some params if needed)
   =========================== */
function resetToDefaultValues() {
    logsheetData.forEach(item => {
        ['unit1','unit2','unit3'].forEach(unit => {
            ['0930','1200','1500','1800','2100'].forEach(time => {
                if (item[unit] && item[unit][time] !== undefined) {
                    // keep values for some parameters if you want; currently reset all except specific ones
                    if (item.parameter === 'Setpoint Chiller' || item.parameter === 'Fan Cooling Tower') {
                        // keep existing
                    } else {
                        item[unit][time] = '';
                    }
                }
            });
        });
    });
}

/* ===========================
   Load last save time
   =========================== */
function loadLastSaveTime() {
    const last = localStorage.getItem('logsheet_last_save');
    if (last) {
        const el = document.getElementById('lastSaveTime');
        if (el) el.textContent = new Date(last).toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });
    }
}

/* ===========================
   Parameter select population
   =========================== */
function populateParameterSelect() {
    const sel = document.getElementById('parameterSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">Pilih Parameter</option>';
    logsheetData.forEach(item => {
        if (item.parameter) {
            const opt = document.createElement('option');
            opt.value = item.no;
            opt.textContent = `${item.no}. ${item.parameter}`;
            sel.appendChild(opt);
        }
    });
}

/* ===========================
   Validate value vs range (basic parsing)
   =========================== */
function validateValue(value, range, unit) {
    if (value === '' || value === undefined || range === 'Actual') return true;
    const num = parseFloat(value);
    if (isNaN(num)) return true;
    // handle ranges like "27-31¬∞C" -> 27 and 31
    if (range.includes('-')) {
        const pair = range.replace(/[^\d\-\.\s]/g,'').split('-').map(s => parseFloat(s)).filter(n=>!isNaN(n));
        if (pair.length === 2) {
            return num >= pair[0] && num <= pair[1];
        }
    }
    if (range.includes('<')) {
        const max = parseFloat(range.replace(/[^\d\.\-]/g,''));
        if (!isNaN(max)) return num < max;
    }
    if (range.includes('>')) {
        const min = parseFloat(range.replace(/[^\d\.\-]/g,''));
        if (!isNaN(min)) return num > min;
    }
    return true;
}

/* ===========================
   Statistics panel updater
   - updates elements: #completionRate, #warningParams, #avgLoad, #systemStatus
   =========================== */
function updateStatistics() {
    let total = 0, filled = 0, out = 0, totalLoad = 0, loadCount = 0;
    logsheetData.forEach(item => {
        if (!item.parameter) return;
        ['unit1','unit2','unit3'].forEach(u => {
            ['0930','1200','1500','1800','2100'].forEach(t => {
                total++;
                const v = item[u][t];
                if (v !== '' && v !== undefined) {
                    filled++;
                    if (!validateValue(v, item.range, item.unit)) out++;
                    if (item.parameter === 'Percent Load Current') { totalLoad += parseFloat(v); loadCount++; }
                }
            });
        });
    });
    const completion = total ? ((filled/total)*100).toFixed(1) : '0.0';
    const avgLoad = loadCount ? (totalLoad/loadCount).toFixed(1) : '0.0';
    const statusText = out === 0 ? 'üü¢ Normal' : (out <= 3 ? 'üü° Perhatian' : 'üî¥ Critical');

    const elCompletion = document.getElementById('completionRate');
    if (elCompletion) elCompletion.textContent = `${completion}%`;
    const elWarn = document.getElementById('warningParams');
    if (elWarn) elWarn.textContent = out;
    const elAvg = document.getElementById('avgLoad');
    if (elAvg) elAvg.textContent = `${avgLoad}%`;
    const elStatus = document.getElementById('systemStatus');
    if (elStatus) elStatus.textContent = statusText;
}

/* ===========================
   Staff data functions
   =========================== */
let staffData = {
    '0930':'','1200':'','1500':'','1800':'','2100':'',
    supervisor:'', manager:'',
    signature0930:'', signature1200:'', signature1500:'', signature1800:'', signature2100:'',
    supervisorSignature:'', managerSignature:''
};

function saveStaffData() {
    const date = document.getElementById('dateSelect').value;
    staffData = {
        '0930': document.getElementById('staff0930') ? document.getElementById('staff0930').value : '',
        '1200': document.getElementById('staff1200') ? document.getElementById('staff1200').value : '',
        '1500': document.getElementById('staff1500') ? document.getElementById('staff1500').value : '',
        '1800': document.getElementById('staff1800') ? document.getElementById('staff1800').value : '',
        '2100': document.getElementById('staff2100') ? document.getElementById('staff2100').value : '',
        supervisor: document.getElementById('supervisor') ? document.getElementById('supervisor').value : '',
        manager: document.getElementById('manager') ? document.getElementById('manager').value : '',
        signature0930: document.getElementById('signature0930') ? document.getElementById('signature0930').value : '',
        signature1200: document.getElementById('signature1200') ? document.getElementById('signature1200').value : '',
        signature1500: document.getElementById('signature1500') ? document.getElementById('signature1500').value : '',
        signature1800: document.getElementById('signature1800') ? document.getElementById('signature1800').value : '',
        signature2100: document.getElementById('signature2100') ? document.getElementById('signature2100').value : '',
        supervisorSignature: document.getElementById('supervisorSignature') ? document.getElementById('supervisorSignature').value : '',
        managerSignature: document.getElementById('managerSignature') ? document.getElementById('managerSignature').value : ''
    };
    localStorage.setItem(`staff_data_${date}`, JSON.stringify(staffData));
    showNotification('Data petugas tersimpan!', 'success');
}

function loadStaffData(date) {
    if (!date) return;
    const raw = localStorage.getItem(`staff_data_${date}`);
    if (raw) {
        try {
            const data = JSON.parse(raw);
            Object.keys(data).forEach(k => {
                const el = document.getElementById(k);
                if (el) el.value = data[k];
            });
            staffData = data;
        } catch(e) { console.error(e); }
    } else {
        // clear fields
        ['staff0930','staff1200','staff1500','staff1800','staff2100',
         'supervisor','manager',
         'signature0930','signature1200','signature1500','signature1800','signature2100',
         'supervisorSignature','managerSignature'].forEach(id => {
             const el = document.getElementById(id);
             if (el) el.value = '';
         });
        staffData = { '0930':'','1200':'','1500':'','1800':'','2100':'', supervisor:'', manager:'', signature0930:'', signature1200:'', signature1500:'', signature1800:'', signature2100:'', supervisorSignature:'', managerSignature:'' };
    }
}

/* ===========================
   Export functions (ke XLSX)
   - exportLogsheet() and exportMonthlyLogsheet()
   - Reused your existing logic, integrated with current data structure
   =========================== */
function exportLogsheet() {
    // header
    const headers = [["No","Description","Parameter","Unit","Range",
        "Unit1_09:30","Unit1_12:00","Unit1_15:00","Unit1_18:00","Unit1_21:00",
        "Unit2_09:30","Unit2_12:00","Unit2_15:00","Unit2_18:00","Unit2_21:00",
        "Unit3_09:30","Unit3_12:00","Unit3_15:00","Unit3_18:00","Unit3_21:00"]];
    const rows = logsheetData.map(item => [
        item.no, item.description || '', item.parameter || '', item.unit || '', item.range || '',
        item.unit1["0930"], item.unit1["1200"], item.unit1["1500"], item.unit1["1800"], item.unit1["2100"],
        item.unit2["0930"], item.unit2["1200"], item.unit2["1500"], item.unit2["1800"], item.unit2["2100"],
        item.unit3["0930"], item.unit3["1200"], item.unit3["1500"], item.unit3["1800"], item.unit3["2100"]
    ]);
    const ws = XLSX.utils.aoa_to_sheet([...headers, ...rows]);

    // auto widths
    const range = XLSX.utils.decode_range(ws['!ref']);
    const colWidths = [];
    for (let C = range.s.c; C <= range.e.c; ++C) {
        let maxLen = 8;
        for (let R = range.s.r; R <= range.e.r; ++R) {
            const cell = ws[XLSX.utils.encode_cell({r:R,c:C})];
            if (cell && cell.v) {
                const len = String(cell.v).length;
                if (len > maxLen) maxLen = len;
            }
        }
        colWidths.push({wch: maxLen + 2});
    }
    ws['!cols'] = colWidths;

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Data Logsheet');

    // Summary sheet
    const summary = [["Unit","Normal (%)","Out of Range (%)","Kosong (%)","Total Parameter"]];
    const timesArr = ["0930","1200","1500","1800","2100"];
    ['unit1','unit2','unit3'].forEach(unit => {
        let normal=0,out=0,empty=0,total=0;
        logsheetData.forEach(item=>{
            timesArr.forEach(t=>{
                const v = item[unit][t];
                if (v === '' || v === undefined) empty++;
                else if (validateValue(v, item.range, item.unit)) normal++;
                else out++;
                total++;
            });
        });
        summary.push([unit.toUpperCase(), ((normal/total)*100).toFixed(1)+'%', ((out/total)*100).toFixed(1)+'%', ((empty/total)*100).toFixed(1)+'%', total]);
    });
    const wsS = XLSX.utils.aoa_to_sheet(summary);
    XLSX.utils.book_append_sheet(wb, wsS, 'Summary');

    const date = document.getElementById('dateSelect').value || (new Date().toISOString().slice(0,10));
    XLSX.writeFile(wb, `Logsheet_Chiller_${date}.xlsx`);
    showNotification('‚úÖ Logsheet berhasil diexport!', 'success');
}

function exportMonthlyLogsheet() {
    const month = new Date(document.getElementById('dateSelect').value).toISOString().slice(0,7);
    const keys = Object.keys(localStorage).filter(k => k.startsWith(`logsheet_chiller_${month}`));
    if (keys.length === 0) { showNotification(`‚ùå Tidak ada data untuk bulan ${month}`, 'error'); return; }
    const wb = XLSX.utils.book_new();
    let summaryData = [];
    keys.sort();
    keys.forEach(key => {
        const date = key.replace('logsheet_chiller_','');
        const raw = localStorage.getItem(key);
        if (!raw) return;
        let parsed; try { parsed = JSON.parse(raw); } catch(e){ parsed = null; }
        const data = parsed?.data || parsed || [];
        const headers = [["No","Description","Parameter","Unit","Range",
            "Unit1_09:30","Unit1_12:00","Unit1_15:00","Unit1_18:00","Unit1_21:00",
            "Unit2_09:30","Unit2_12:00","Unit2_15:00","Unit2_18:00","Unit2_21:00",
            "Unit3_09:30","Unit3_12:00","Unit3_15:00","Unit3_18:00","Unit3_21:00"]];
        const rows = data.map(item => [
            item.no, item.description || '', item.parameter || '', item.unit || '', item.range || '',
            item.unit1["0930"], item.unit1["1200"], item.unit1["1500"], item.unit1["1800"], item.unit1["2100"],
            item.unit2["0930"], item.unit2["1200"], item.unit2["1500"], item.unit2["1800"], item.unit2["2100"],
            item.unit3["0930"], item.unit3["1200"], item.unit3["1500"], item.unit3["1800"], item.unit3["2100"]
        ]);
        const ws = XLSX.utils.aoa_to_sheet([...headers, ...rows]);
        XLSX.utils.book_append_sheet(wb, ws, date.slice(5)); // sheet name use MM-DD or date (avoid too long)
        // summary per date
        ['unit1','unit2','unit3'].forEach(unit=>{
            let normal=0,out=0,empty=0,total=0;
            data.forEach(item=>{
                ['0930','1200','1500','1800','2100'].forEach(t=>{
                    const v = item[unit][t];
                    if (v === '' || v === undefined) empty++;
                    else if (validateValue(v, item.range, item.unit)) normal++;
                    else out++;
                    total++;
                });
            });
            summaryData.push({tanggal:date, unit:unit.toUpperCase(), normal, out, empty, total});
        });
    });

    const summarySheet = [["Tanggal","Unit","Normal (%)","Out of Range (%)","Kosong (%)","Total Parameter"]];
    summaryData.forEach(s => {
        summarySheet.push([s.tanggal, s.unit, ((s.normal/s.total)*100).toFixed(1)+'%', ((s.out/s.total)*100).toFixed(1)+'%', ((s.empty/s.total)*100).toFixed(1)+'%', s.total]);
    });
    // averages
    summarySheet.push([]);
    summarySheet.push(["üìä RATA-RATA BULANAN", "","","","",""]);
    ['UNIT1','UNIT2','UNIT3'].forEach(unit=>{
        const arr = summaryData.filter(x=>x.unit===unit);
        if (arr.length){
            const avgNormal = (arr.reduce((a,b)=>a + (b.normal/b.total)*100,0)/arr.length).toFixed(1);
            const avgOut = (arr.reduce((a,b)=>a + (b.out/b.total)*100,0)/arr.length).toFixed(1);
            const avgEmpty = (arr.reduce((a,b)=>a + (b.empty/b.total)*100,0)/arr.length).toFixed(1);
            summarySheet.push(["", unit, `${avgNormal}%`, `${avgOut}%`, `${avgEmpty}%`, "Avg"]);
        }
    });
    const wsSummary = XLSX.utils.aoa_to_sheet(summarySheet);
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary Bulanan');

    const fileName = `Logsheet_Chiller_${month}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showNotification('‚úÖ Logsheet bulanan berhasil diexport!', 'success');
}

/* ===========================
   Other utilities: copy previous day, backup, import, reports
   - adapted to current helpers
   =========================== */
function copyFromPreviousDay() {
    const currentDate = document.getElementById('dateSelect').value;
    if (!currentDate) return;
    const prev = new Date(currentDate);
    prev.setDate(prev.getDate()-1);
    const prevKey = `logsheet_chiller_${prev.toISOString().slice(0,10)}`;
    const raw = localStorage.getItem(prevKey);
    if (!raw) { showNotification(`Tidak ada data untuk ${prev.toISOString().slice(0,10)}`,'error'); return; }
    try {
        const parsed = JSON.parse(raw);
        const data = parsed?.data || parsed || [];
        data.forEach((item, i) => {
            if (logsheetData[i] && (item.parameter === 'Setpoint Chiller' || item.parameter === 'Fan Cooling Tower')) {
                logsheetData[i].unit1 = item.unit1;
                logsheetData[i].unit2 = item.unit2;
                logsheetData[i].unit3 = item.unit3;
            }
        });
        populateLogsheetTable(); saveDataToStorage();
        showNotification('Data dari hari sebelumnya berhasil disalin','success');
    } catch(e) { showNotification('Error saat copy data','error'); }
}

function backupAllData() {
    const all = {};
    Object.keys(localStorage).filter(k=>k.startsWith('logsheet_chiller_')).forEach(k => all[k]=localStorage.getItem(k));
    Object.keys(localStorage).filter(k=>k.startsWith('staff_data_')).forEach(k => all[k]=localStorage.getItem(k));
    const blob = new Blob([JSON.stringify({version:'2.0', timestamp:new Date().toISOString(), data:all},null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `Backup_Logsheet_${new Date().toISOString().slice(0,10)}.json`; a.click(); a.remove();
    showNotification('Backup berhasil','success');
}

function importBackupData() {
    const input = document.createElement('input'); input.type='file'; input.accept='.json';
    input.onchange = e => {
        const f = e.target.files[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const backup = JSON.parse(ev.target.result);
                if (backup.data) {
                    Object.keys(backup.data).forEach(k => localStorage.setItem(k, backup.data[k]));
                    showNotification('Import backup berhasil','success');
                    // reload current date
                    const d = document.getElementById('dateSelect').value;
                    loadDataForDate(d); loadStaffData(d);
                } else showNotification('File backup tidak valid','error');
            } catch(e){ showNotification('Error membaca file','error'); }
        };
        reader.readAsText(f);
    };
    input.click();
}

/* ===========================
   Print, refresh, modal helpers, form handler
   =========================== */
function refreshData(event) {
    const btn = event ? event.target : null;
    if (btn) { btn.disabled = true; btn.innerHTML = 'üîÑ Refreshing...'; }
    setTimeout(()=> {
        updateDateTime();
        populateLogsheetTable();
        updateStatistics();
        if (btn) { btn.disabled = false; btn.innerHTML = 'üîÑ Refresh'; }
        showNotification('Data berhasil diperbarui!','success');
    }, 600);
}

function printLogsheet(){ window.print(); }
function inputData(){ document.getElementById('inputModal').classList.remove('hidden'); }
function closeInputModal(){ document.getElementById('inputModal').classList.add('hidden'); document.getElementById('inputForm').reset(); }
function closeQuickInputModal(){ document.getElementById('quickInputModal').classList.add('hidden'); }

/* Input modal submit */
const inputForm = document.getElementById('inputForm');
if (inputForm) {
    inputForm.addEventListener('submit', function(e){
        e.preventDefault();
        const paramNo = document.getElementById('parameterSelect').value;
        const unit = document.getElementById('unitInput').value;
        const time = document.getElementById('timeInput').value;
        const raw = document.getElementById('valueInput').value;
        const value = raw === '' ? '' : parseFloat(raw);
        if (paramNo && unit && time && raw !== '') {
            const item = logsheetData.find(i => i.no == paramNo);
            if (item) {
                item[unit][time] = value;
                populateLogsheetTable(); updateStatistics(); saveDataToStorage(); closeInputModal();
                showNotification('Data berhasil disimpan!', 'success');
            }
        } else showNotification('Mohon lengkapi semua field!', 'error');
    });
}

/* ===========================
   Init: when DOM loaded
   - populate parameter select
   - load selected date's data
   =========================== */
function initializeLogsheet() {
    populateParameterSelect();
    const dateInput = document.getElementById('dateSelect');
    const selectedDate = dateInput && dateInput.value ? dateInput.value : (new Date().toISOString().slice(0,10));
    // Ensure date picker shows selected
    if (dateInput) dateInput.value = selectedDate;
    loadStaffData(selectedDate);
    loadDataForDate(selectedDate);
    loadLastSaveTime();
    updateDateTime();
    updateStatistics();
}
window.addEventListener('DOMContentLoaded', initializeLogsheet);
</script>

        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Quick Input Mode Functions
        function quickInputMode() {
            document.getElementById('quickInputModal').classList.remove('hidden');
            populateQuickInputTable();
        }

        function closeQuickInputModal() {
            document.getElementById('quickInputModal').classList.add('hidden');
        }

        function populateQuickInputTable() {
            const tbody = document.getElementById('quickInputTableBody');
            const selectedUnit = document.getElementById('quickUnitSelect').value;
            const selectedTime = document.getElementById('quickTimeSelect').value;
            
            tbody.innerHTML = '';

            logsheetData.forEach(item => {
                if (item.parameter) {
                    const row = document.createElement('tr');
                    const currentValue = item[selectedUnit][selectedTime];
                    const isValid = validateValue(currentValue, item.range, item.unit);
                    
                    const statusClass = currentValue === '' ? 'bg-gray-100' : 
                                       isValid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const statusText = currentValue === '' ? 'Belum diisi' : 
                                      isValid ? '‚úÖ Normal' : '‚ö†Ô∏è Di luar range';

                    row.innerHTML = `
                        <td class="border border-gray-300 p-2 text-center">${item.no}</td>
                        <td class="border border-gray-300 p-2">${item.parameter}</td>
                        <td class="border border-gray-300 p-2 text-center">${item.unit}</td>
                        <td class="border border-gray-300 p-2 text-xs">${item.range}</td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="number" step="0.1" 
                                   value="${currentValue}" 
                                   data-param="${item.no}"
                                   data-unit="${selectedUnit}"
                                   data-time="${selectedTime}"
                                   class="w-full text-center border-0 bg-transparent focus:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1"
                                   onkeydown="handleQuickInputKeydown(event)"
                                   onblur="updateQuickInputValue(this)">
                        </td>
                        <td class="border border-gray-300 p-2 text-center">
                            <span class="px-2 py-1 rounded text-xs ${statusClass}">${statusText}</span>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        function handleQuickInputKeydown(event) {
            if (event.key === 'Enter') {
                updateQuickInputValue(event.target);
                event.target.blur();
            } else if (event.key === 'Escape') {
                event.target.blur();
            }
        }

        function updateQuickInputValue(input) {
            const paramNo = input.dataset.param;
            const unit = input.dataset.unit;
            const time = input.dataset.time;
            const value = parseFloat(input.value) || '';
            
            const dataItem = logsheetData.find(item => item.no == paramNo);
            if (dataItem) {
                dataItem[unit][time] = value;
                saveDataToStorage();
                
                // Update status
                const row = input.closest('tr');
                const statusCell = row.querySelector('td:last-child span');
                const isValid = validateValue(value, dataItem.range, dataItem.unit);
                
                if (value === '') {
                    statusCell.className = 'px-2 py-1 rounded text-xs bg-gray-100';
                    statusCell.textContent = 'Belum diisi';
                } else if (isValid) {
                    statusCell.className = 'px-2 py-1 rounded text-xs bg-green-100 text-green-800';
                    statusCell.textContent = '‚úÖ Normal';
                } else {
                    statusCell.className = 'px-2 py-1 rounded text-xs bg-red-100 text-red-800';
                    statusCell.textContent = '‚ö†Ô∏è Di luar range';
                }
            }
        }

        function saveAllQuickInput() {
            populateLogsheetTable();
            updateStatistics();
            showNotification('Semua data berhasil disimpan!', 'success');
        }

        // Update quick input table when unit or time changes
        document.getElementById('quickUnitSelect').addEventListener('change', populateQuickInputTable);
        document.getElementById('quickTimeSelect').addEventListener('change', populateQuickInputTable);

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeLogsheet();
            // Load data for current date
            const currentDate = document.getElementById('dateSelect').value;
            loadDataForDate(currentDate);
            loadStaffData(currentDate);
        });

        // Auto-refresh every 5 minutes
        setInterval(updateDateTime, 300000);
        
        // Auto-save every 30 seconds if there are changes
        setInterval(() => {
            const lastSave = localStorage.getItem('logsheet_last_save');
            const now = new Date().toISOString();
            if (!lastSave || (new Date(now) - new Date(lastSave)) > 30000) {
                // Only save if there's actual data
                const hasData = logsheetData.some(item => 
                    Object.values(item.unit1).some(v => v !== '') ||
                    Object.values(item.unit2).some(v => v !== '') ||
                    Object.values(item.unit3).some(v => v !== '')
                );
                if (hasData) {
                    saveDataToStorage();
                }
            }
        }, 30000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974e69cb204cf46d',t:'MTc1NjE1OTc2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>




