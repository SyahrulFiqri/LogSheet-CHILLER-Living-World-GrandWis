<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGSHEET CHILLER PLAN - Mall Living World Grand Wisata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .logsheet-table { font-size: 11px; }
        .parameter-cell { min-width: 150px; }
        .unit-cell { min-width: 80px; }
        .value-cell { min-width: 60px; text-align: center; }
        .time-header { font-weight: bold; background: #f3f4f6; }
        .section-header { background: #e5e7eb; font-weight: bold; }
        .out-of-range { background-color: #fef2f2; color: #dc2626; font-weight: bold; }
        .in-range { background-color: #f0fdf4; color: #166534; }
        .pulse-save { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @media print {
            .no-print { display: none; }
            body { font-size: 9px; }
            .logsheet-table { font-size: 8px; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-bg text-white p-6 mb-6 no-print">
        <div class="max-w-7xl mx-auto text-center">
            <h1 class="text-3xl font-bold mb-2">‚ùÑÔ∏è LOGSHEET CHILLER PLAN</h1>
            <h2 class="text-xl font-semibold mb-1">MALL LIVING WORLD GRAND WISATA</h2>
            <p class="text-blue-100">Sistem Monitoring & Pelaporan Data Chiller - Advanced Version 2.0</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4">
        <!-- Control Panel -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-6 no-print">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="dateSelect" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" value="2025-01-15" onchange="updateDateDisplay()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                        <select id="unitSelect" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="all">Semua Unit</option>
                            <option value="unit1">Unit No.1</option>
                            <option value="unit2">Unit No.2</option>
                            <option value="unit3">Unit No.3</option>
                        </select>
                    </div>
                    <div class="text-xs text-gray-600">
                        <div>üíæ Auto-save: <span id="autoSaveStatus" class="text-green-600">Aktif</span></div>
                        <div>üïí Last save: <span id="lastSaveTime">-</span></div>
                    </div>
                </div>
                
                <!-- Main Action Buttons -->
                <div class="flex gap-2 flex-wrap">
                    <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-medium transition-colors text-sm">
                        üîÑ Refresh
                    </button>
                    <button onclick="quickInputMode()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg font-medium transition-colors text-sm">
                        ‚ö° Input Cepat
                    </button>
                    <button onclick="inputData()" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg font-medium transition-colors text-sm">
                        ‚úèÔ∏è Input Data
                    </button>
                </div>
            </div>
            
            <!-- Advanced Features Row -->
            <div class="border-t pt-4 mt-4">
                <div class="flex flex-wrap gap-2">
                    <div class="flex gap-2">
                        <span class="text-sm font-medium text-gray-700 self-center">üìä Export:</span>
                       <button onclick="exportLogsheet()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            üìä Export Excel
                        </button>
                        <button onclick="exportMonthlyLogsheet()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            üìÜ Export Bulanan
                        </button>

                        <button onclick="generateDailyReport()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                            üìã Laporan
                        </button>
                        <button onclick="printLogsheet()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                            üñ®Ô∏è Print
                        </button>
                    </div>
                    
                    <div class="flex gap-2 ml-4">
                        <span class="text-sm font-medium text-gray-700 self-center">üíæ Data:</span>
                        <button onclick="backupAllData()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
                            üì¶ Backup
                        </button>
                        <button onclick="importBackupData()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded text-sm">
                            üì• Import
                        </button>
                        <button onclick="copyFromPreviousDay()" class="bg-pink-600 hover:bg-pink-700 text-white px-3 py-1 rounded text-sm">
                            üìã Copy Kemarin
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 no-print">
            <div class="bg-white rounded-lg card-shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Unit Beroperasi</p>
                        <p class="text-2xl font-bold text-green-600" id="operatingUnits">3</p>
                    </div>
                    <div class="bg-green-100 p-2 rounded-full">
                        <span class="text-xl">‚úÖ</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg card-shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Data Lengkap</p>
                        <p class="text-2xl font-bold text-blue-600" id="completionRate">89%</p>
                    </div>
                    <div class="bg-blue-100 p-2 rounded-full">
                        <span class="text-xl">üìä</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg card-shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Perlu Perhatian</p>
                        <p class="text-2xl font-bold text-yellow-600" id="warningParams">7</p>
                    </div>
                    <div class="bg-yellow-100 p-2 rounded-full">
                        <span class="text-xl">‚ö†Ô∏è</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg card-shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Avg Load</p>
                        <p class="text-2xl font-bold text-purple-600" id="avgLoad">96.2%</p>
                    </div>
                    <div class="bg-purple-100 p-2 rounded-full">
                        <span class="text-xl">‚ö°</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg card-shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Status Sistem</p>
                        <p class="text-sm font-bold text-green-600" id="systemStatus">üü¢ Normal</p>
                    </div>
                    <div class="bg-green-100 p-2 rounded-full">
                        <span class="text-xl">üîß</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Logsheet Table -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">üìã LOGSHEET CHILLER PLAN</h3>
                    <p class="text-sm text-gray-600">Tanggal: <span id="currentDate">15 Januari 2025</span></p>
                </div>
                <div class="text-right text-sm text-gray-600 no-print">
                    <p>Last Update: <span id="lastUpdate">15:30 WIB</span></p>
                    <p class="text-xs">Version 2.0 - Advanced Features</p>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300 logsheet-table">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 p-2 text-center">No</th>
                            <th class="border border-gray-300 p-2 text-center parameter-cell">Description</th>
                            <th class="border border-gray-300 p-2 text-center">Parameter</th>
                            <th class="border border-gray-300 p-2 text-center unit-cell">Unit</th>
                            <th class="border border-gray-300 p-2 text-center time-header" colspan="5">Unit No.1</th>
                            <th class="border border-gray-300 p-2 text-center time-header" colspan="5">Unit No.2</th>
                            <th class="border border-gray-300 p-2 text-center time-header" colspan="5">Unit No.3</th>
                            <th class="border border-gray-300 p-2 text-center">Keterangan</th>
                        </tr>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-300 p-1"></th>
                            <th class="border border-gray-300 p-1"></th>
                            <th class="border border-gray-300 p-1"></th>
                            <th class="border border-gray-300 p-1"></th>
                            <th class="border border-gray-300 p-1 text-xs">09:30</th>
                            <th class="border border-gray-300 p-1 text-xs">12:00</th>
                            <th class="border border-gray-300 p-1 text-xs">15:00</th>
                            <th class="border border-gray-300 p-1 text-xs">18:00</th>
                            <th class="border border-gray-300 p-1 text-xs">21:00</th>
                            <th class="border border-gray-300 p-1 text-xs">09:30</th>
                            <th class="border border-gray-300 p-1 text-xs">12:00</th>
                            <th class="border border-gray-300 p-1 text-xs">15:00</th>
                            <th class="border border-gray-300 p-1 text-xs">18:00</th>
                            <th class="border border-gray-300 p-1 text-xs">21:00</th>
                            <th class="border border-gray-300 p-1 text-xs">09:30</th>
                            <th class="border border-gray-300 p-1 text-xs">12:00</th>
                            <th class="border border-gray-300 p-1 text-xs">15:00</th>
                            <th class="border border-gray-300 p-1 text-xs">18:00</th>
                            <th class="border border-gray-300 p-1 text-xs">21:00</th>
                            <th class="border border-gray-300 p-1"></th>
                        </tr>
                    </thead>
                    <tbody id="logsheetTableBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Signature Section -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">üë• Tanda Tangan Petugas</h3>
            <div class="grid grid-cols-1 md:grid-cols-7 gap-4 text-center">
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Dibuat Oleh</p>
                    <input type="text" id="supervisor" placeholder="Nama Supervisor" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-12 mb-2 border-t border-gray-200 pt-2">
                        <input type="text" id="supervisorSignature" placeholder="Tanda tangan digital" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                    <p class="text-xs font-medium">Spv. Engineering</p>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Pic Logsheet</p>
                    <p class="text-xs mb-1 font-medium">09:30</p>
                    <input type="text" id="staff0930" placeholder="Nama Petugas" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-8 mb-2 border-t border-gray-200 pt-1">
                        <input type="text" id="signature0930" placeholder="TTD" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-1 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Pic Logsheet</p>
                    <p class="text-xs mb-1 font-medium">12:00</p>
                    <input type="text" id="staff1200" placeholder="Nama Petugas" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-8 mb-2 border-t border-gray-200 pt-1">
                        <input type="text" id="signature1200" placeholder="TTD" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-1 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Pic Logsheet</p>
                    <p class="text-xs mb-1 font-medium">15:00</p>
                    <input type="text" id="staff1500" placeholder="Nama Petugas" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-8 mb-2 border-t border-gray-200 pt-1">
                        <input type="text" id="signature1500" placeholder="TTD" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-1 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Pic Logsheet</p>
                    <p class="text-xs mb-1 font-medium">18:00</p>
                    <input type="text" id="staff1800" placeholder="Nama Petugas" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-8 mb-2 border-t border-gray-200 pt-1">
                        <input type="text" id="signature1800" placeholder="TTD" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-1 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Pic Logsheet</p>
                    <p class="text-xs mb-1 font-medium">21:00</p>
                    <input type="text" id="staff2100" placeholder="Nama Petugas" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-8 mb-2 border-t border-gray-200 pt-1">
                        <input type="text" id="signature2100" placeholder="TTD" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-1 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                </div>
                <div class="border border-gray-300 p-4 rounded">
                    <p class="font-semibold text-sm mb-2">Mengetahui</p>
                    <input type="text" id="manager" placeholder="Nama Manager" 
                           class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 mb-2 focus:ring-2 focus:ring-blue-500"
                           onchange="saveStaffData()">
                    <div class="h-12 mb-2 border-t border-gray-200 pt-2">
                        <input type="text" id="managerSignature" placeholder="Tanda tangan digital" 
                               class="w-full text-center text-xs border border-gray-200 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500"
                               onchange="saveStaffData()">
                    </div>
                    <p class="text-xs font-medium">Manager Engineering</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Data Modal -->
    <div id="inputModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Input Data Parameter</h3>
                    <button onclick="closeInputModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
                <form id="inputForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Parameter</label>
                            <select id="parameterSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="">Pilih Parameter</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Unit</label>
                            <select id="unitInput" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="unit1">Unit No.1</option>
                                <option value="unit2">Unit No.2</option>
                                <option value="unit3">Unit No.3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Waktu</label>
                            <select id="timeInput" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="0930">09:30</option>
                                <option value="1200">12:00</option>
                                <option value="1500">15:00</option>
                                <option value="1800">18:00</option>
                                <option value="2100">21:00</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Nilai</label>
                            <input type="number" step="0.1" id="valueInput" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Masukkan nilai">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeInputModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg">Batal</button>
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Input Modal -->
    <div id="quickInputModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-6xl w-full p-6 max-h-screen overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold">‚ö° Mode Input Cepat</h3>
                        <p class="text-sm text-gray-600">Klik langsung pada sel untuk mengedit nilai</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div>
                            <label class="block text-xs font-medium mb-1">Unit</label>
                            <select id="quickUnitSelect" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                <option value="unit1">Unit No.1</option>
                                <option value="unit2">Unit No.2</option>
                                <option value="unit3">Unit No.3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Waktu</label>
                            <select id="quickTimeSelect" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                <option value="0930">09:30</option>
                                <option value="1200">12:00</option>
                                <option value="1500">15:00</option>
                                <option value="1800">18:00</option>
                                <option value="2100">21:00</option>
                            </select>
                        </div>
                        <button onclick="closeQuickInputModal()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg mb-4">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs">Tips:</span>
                        <span>Pilih Unit dan Waktu di atas, lalu klik nilai yang ingin diubah. Tekan Enter untuk simpan atau Esc untuk batal.</span>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 text-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-2">No</th>
                                <th class="border border-gray-300 p-2 min-w-48">Parameter</th>
                                <th class="border border-gray-300 p-2">Unit</th>
                                <th class="border border-gray-300 p-2">Range</th>
                                <th class="border border-gray-300 p-2">Nilai Saat Ini</th>
                                <th class="border border-gray-300 p-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="quickInputTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-between items-center mt-6">
                    <div class="text-sm text-gray-600">
                        <span class="inline-block w-4 h-4 bg-green-100 border mr-1"></span> Normal
                        <span class="inline-block w-4 h-4 bg-red-100 border mr-1 ml-3"></span> Di luar range
                        <span class="inline-block w-4 h-4 bg-gray-100 border mr-1 ml-3"></span> Belum diisi
                    </div>
                    <div class="flex gap-3">
                        <button onclick="saveAllQuickInput()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            üíæ Simpan Semua
                        </button>
                        <button onclick="closeQuickInputModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            Tutup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
/* ===========================
   LOGSHEET DATA (your existing data)
   =========================== */
const logsheetData = [
  /* <-- PASTE your full array here (same as you already have) --> */
  // Example small snippet ‚Äî replace with your full array:
  { no: 1, section: 'Condenser status', description: 'Condenser status', parameter: 'Water In Temp.', unit: '¬∞C', range: '27-31¬∞C',
    unit1: { '0930': 29.7, '1200': 29.4, '1500': '', '1800': '', '2100': '' },
    unit2: { '0930': 29.8, '1200': 29.4, '1500': '', '1800': '', '2100': '' },
    unit3: { '0930': 29.7, '1200': 29.4, '1500': '', '1800': '', '2100': '' } }
  // ... full list continues (use the same content you already have)
];

/* ===========================
   STAFF DATA (defaults)
   =========================== */
let staffData = {
  '0930': '', '1200': '', '1500': '', '1800': '', '2100': '',
  supervisor: '', manager: '',
  signature0930: '', signature1200: '', signature1500: '', signature1800: '', signature2100: '',
  supervisorSignature: '', managerSignature: ''
};

/* ===========================
   Helper: show notification (toast)
   =========================== */
function showNotification(message, type = 'info', timeout = 2500) {
  let container = document.getElementById('toastContainer');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toastContainer';
    container.style.position = 'fixed';
    container.style.right = '16px';
    container.style.top = '16px';
    container.style.zIndex = 9999;
    document.body.appendChild(container);
  }
  const el = document.createElement('div');
  el.textContent = message;
  el.style.marginTop = '8px';
  el.style.padding = '10px 14px';
  el.style.borderRadius = '8px';
  el.style.color = '#fff';
  el.style.fontSize = '13px';
  el.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
  if (type === 'success') el.style.background = '#16a34a';
  else if (type === 'error') el.style.background = '#dc2626';
  else if (type === 'warning') el.style.background = '#d97706';
  else el.style.background = '#0ea5e9';
  container.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; setTimeout(()=>el.remove(),400); }, timeout);
}

/* ===========================
   Validate value vs range (robust)
   =========================== */
function validateValue(value, range, unit) {
  if (value === '' || value === undefined || range === 'Actual') return true;
  const num = parseFloat(value);
  if (isNaN(num)) return true;

  // normalize range string to extract numbers
  if (range.includes('-')) {
    // e.g. "27-31¬∞C" or "1.0-3.3"
    const nums = range.replace(/[^\d\.\-\s]/g, '').split('-').map(s => parseFloat(s)).filter(n => !isNaN(n));
    if (nums.length === 2) return num >= nums[0] && num <= nums[1];
  }
  if (range.includes('<')) {
    const max = parseFloat(range.replace(/[^\d\.\-]/g, ''));
    if (!isNaN(max)) return num < max;
  }
  if (range.includes('>')) {
    const min = parseFloat(range.replace(/[^\d\.\-]/g, ''));
    if (!isNaN(min)) return num > min;
  }
  return true;
}

/* ===========================
   Generate unit cell HTML (input inside each cell)
   - rowNo used to match item.no when updating
   =========================== */
function generateUnitCells(unitData, range, unit, unitKey, rowNo) {
  const times = ['0930','1200','1500','1800','2100'];
  return times.map(t => {
    const val = unitData?.[t] ?? '';
    const displayValue = (val === '' || val === null || val === undefined) ? '' : val;
    const isValid = validateValue(displayValue, range, unit);
    const cellClass = displayValue === '' ? '' : (isValid ? 'in-range' : 'out-of-range');
    return `
      <td class="border border-gray-300 p-1 text-center value-cell ${cellClass}">
        <input type="number" step="0.1"
               value="${displayValue ?? ''}"
               onchange="updateValue(${rowNo}, '${unitKey}', '${t}', this.value)"
               class="w-16 text-center border rounded px-1 py-0.5 text-xs">
      </td>`;
  }).join('');
}

function populateLogsheetTable() {
    const tbody = document.getElementById('logsheetTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    logsheetData.forEach(item => {
        const tr = document.createElement('tr');
        const isSection = item.section && item.description === item.section;
        if (isSection) tr.className = 'bg-gray-100 font-semibold';

        const noTd = `<td class="border border-gray-300 p-2 text-center">${item.no}</td>`;
        const descTd = `<td class="border border-gray-300 p-2">${item.description || ''}</td>`;
        const paramTd = `<td class="border border-gray-300 p-2">${item.parameter || ''}</td>`;
        const unitTd = `<td class="border border-gray-300 p-2 text-center">${item.unit || ''}</td>`;

        const times = ['0930', '1200', '1500', '1800', '2100'];
        function unitCells(unitKey) {
            return times.map(t => {
                const value = item[unitKey]?.[t] ?? '';
                return `
                    <td class="border border-gray-300 p-1 text-center">
                        <input type="number" step="0.1" 
                            value="${value}"
                            onchange="updateValue(${item.no}, '${unitKey}', '${t}', this.value)"
                            class="w-16 text-center border rounded px-1 py-0.5 text-xs">
                    </td>`;
            }).join('');
        }

        tr.innerHTML = noTd + descTd + paramTd + unitTd +
                       unitCells('unit1') + unitCells('unit2') + unitCells('unit3') +
                       `<td class="border border-gray-300 p-2 text-center text-xs"></td>`;

        tbody.appendChild(tr);
    });
}

/* ===========================
   Update value (from inputs) & save
   =========================== */
function updateValue(rowNo, unitKey, time, value) {
  const idx = logsheetData.findIndex(i => i.no === rowNo);
  if (idx === -1) return;
  logsheetData[idx][unitKey][time] = (value === '' ? '' : (isNaN(value) ? value : parseFloat(value)));
  saveDataToStorage();
  updateStatistics();
  // re-render to update colors/status
  populateLogsheetTable();
}

/* ===========================
   Save to localStorage (with metadata)
   =========================== */
function saveDataToStorage() {
  const date = document.getElementById('dateSelect')?.value;
  if (!date) return;
  const key = `logsheet_chiller_${date}`;
  const ts = new Date().toISOString();
  const payload = {
    version: '2.0',
    timestamp: ts,
    date,
    data: logsheetData,
    metadata: { facility: 'Mall Living World Grand Wisata', lastModified: ts }
  };
  localStorage.setItem(key, JSON.stringify(payload));
  localStorage.setItem('logsheet_last_save', ts);
  const lastSaveEl = document.getElementById('lastSaveTime');
  if (lastSaveEl) lastSaveEl.textContent = new Date(ts).toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });

  const saveStatus = document.getElementById('autoSaveStatus');
  if (saveStatus) {
    saveStatus.textContent = 'Tersimpan';
    saveStatus.className = 'text-green-600 pulse-save';
    setTimeout(()=> saveStatus.className = 'text-green-600', 2000);
  }
}

/* ===========================
   Load data for a date (handles old/new format)
   =========================== */
function loadDataForDate(date) {
  if (!date) return;
  const key = `logsheet_chiller_${date}`;
  const raw = localStorage.getItem(key);
  if (!raw) {
    resetToDefaultValues();
    populateLogsheetTable();
    updateStatistics();
    return;
  }
  try {
    const parsed = JSON.parse(raw);
    const arr = parsed.data || parsed;
    arr.forEach((savedItem, i) => {
      if (!logsheetData[i]) return;
      if (savedItem.unit1) logsheetData[i].unit1 = savedItem.unit1;
      if (savedItem.unit2) logsheetData[i].unit2 = savedItem.unit2;
      if (savedItem.unit3) logsheetData[i].unit3 = savedItem.unit3;
    });
    populateLogsheetTable();
    updateStatistics();
    showNotification(`Data untuk ${date} berhasil dimuat!`, 'success');
  } catch (e) {
    console.error(e);
    showNotification('Error loading data for this date', 'error');
  }
}

/* ===========================
   Reset default values (clears non-exempt parameters)
   =========================== */
function resetToDefaultValues() {
  logsheetData.forEach(item => {
    ['unit1','unit2','unit3'].forEach(unit => {
      ['0930','1200','1500','1800','2100'].forEach(time => {
        if (item[unit] && item[unit][time] !== undefined) {
          if (item.parameter === 'Setpoint Chiller' || item.parameter === 'Fan Cooling Tower') {
            // keep defaults
          } else {
            item[unit][time] = '';
          }
        }
      });
    });
  });
}

/* ===========================
   Load last save time to UI
   =========================== */
function loadLastSaveTime() {
  const last = localStorage.getItem('logsheet_last_save');
  if (last) {
    const el = document.getElementById('lastSaveTime');
    if (el) el.textContent = new Date(last).toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });
  }
}

/* ===========================
   Statistics & small dashboard updates
   =========================== */
function updateStatistics() {
  let total = 0, filled = 0, outOfRange = 0, totalLoad = 0, loadCount = 0;
  logsheetData.forEach(item => {
    if (!item.parameter) return;
    ['unit1','unit2','unit3'].forEach(u => {
      ['0930','1200','1500','1800','2100'].forEach(t => {
        total++;
        const v = item[u][t];
        if (v !== '' && v !== undefined) {
          filled++;
          if (!validateValue(v, item.range, item.unit)) outOfRange++;
          if (item.parameter === 'Percent Load Current') {
            totalLoad += parseFloat(v) || 0;
            loadCount++;
          }
        }
      });
    });
  });
  const completion = total ? ((filled/total)*100).toFixed(1) : '0.0';
  const avgLoad = loadCount ? (totalLoad/loadCount).toFixed(1) : '0.0';
  const compEl = document.getElementById('completionRate');
  const warnEl = document.getElementById('warningParams');
  const avgEl = document.getElementById('avgLoad');
  const sysEl = document.getElementById('systemStatus');
  if (compEl) compEl.textContent = `${completion}%`;
  if (warnEl) warnEl.textContent = outOfRange;
  if (avgEl) avgEl.textContent = `${avgLoad}%`;
  if (sysEl) {
    const statusText = outOfRange === 0 ? 'üü¢ Normal' : (outOfRange <= 3 ? 'üü° Perhatian' : 'üî¥ Critical');
    sysEl.textContent = statusText;
  }
}

/* ===========================
   Parameter select population
   =========================== */
function populateParameterSelect() {
  const sel = document.getElementById('parameterSelect');
  if (!sel) return;
  sel.innerHTML = '<option value="">Pilih Parameter</option>';
  logsheetData.forEach(item => {
    if (item.parameter) {
      const opt = document.createElement('option');
      opt.value = item.no;
      opt.textContent = `${item.no}. ${item.parameter}`;
      sel.appendChild(opt);
    }
  });
}

/* ===========================
   Staff data save/load
   =========================== */
function saveStaffData() {
  const date = document.getElementById('dateSelect')?.value;
  if (!date) return;
  staffData = {
    '0930': document.getElementById('staff0930')?.value || '',
    '1200': document.getElementById('staff1200')?.value || '',
    '1500': document.getElementById('staff1500')?.value || '',
    '1800': document.getElementById('staff1800')?.value || '',
    '2100': document.getElementById('staff2100')?.value || '',
    supervisor: document.getElementById('supervisor')?.value || '',
    manager: document.getElementById('manager')?.value || '',
    signature0930: document.getElementById('signature0930')?.value || '',
    signature1200: document.getElementById('signature1200')?.value || '',
    signature1500: document.getElementById('signature1500')?.value || '',
    signature1800: document.getElementById('signature1800')?.value || '',
    signature2100: document.getElementById('signature2100')?.value || '',
    supervisorSignature: document.getElementById('supervisorSignature')?.value || '',
    managerSignature: document.getElementById('managerSignature')?.value || ''
  };
  localStorage.setItem(`staff_data_${date}`, JSON.stringify(staffData));
  showNotification('Data petugas tersimpan!', 'success');
}

function loadStaffData(date) {
  if (!date) return;
  const raw = localStorage.getItem(`staff_data_${date}`);
  if (!raw) {
    // clear fields
    ['staff0930','staff1200','staff1500','staff1800','staff2100','supervisor','manager','signature0930','signature1200','signature1500','signature1800','signature2100','supervisorSignature','managerSignature']
      .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    staffData = { '0930':'','1200':'','1500':'','1800':'','2100':'', supervisor:'', manager:'', signature0930:'', signature1200:'', signature1500:'', signature1800:'', signature2100:'', supervisorSignature:'', managerSignature:'' };
    return;
  }
  try {
    const parsed = JSON.parse(raw);
    Object.keys(parsed).forEach(k => {
      const el = document.getElementById(k);
      if (el) el.value = parsed[k] || '';
    });
    staffData = parsed;
  } catch (e) {
    console.error(e);
  }
}

/* ===========================
   Input modal open/close
   =========================== */
function inputData() { document.getElementById('inputModal')?.classList.remove('hidden'); }
function closeInputModal() {
  document.getElementById('inputModal')?.classList.add('hidden');
  document.getElementById('inputForm')?.reset();
}

/* ===========================
   Handle input form submission
   =========================== */
document.addEventListener('submit', function(e){
  if (e.target && e.target.id === 'inputForm') {
    e.preventDefault();
    const paramNo = document.getElementById('parameterSelect')?.value;
    const unit = document.getElementById('unitInput')?.value;
    const time = document.getElementById('timeInput')?.value;
    const rawVal = document.getElementById('valueInput')?.value;
    const value = rawVal === '' ? '' : parseFloat(rawVal);
    if (paramNo && unit && time && (rawVal !== '')) {
      const item = logsheetData.find(i => i.no == paramNo);
      if (item) {
        item[unit][time] = isNaN(value) ? rawVal : value;
        populateLogsheetTable();
        updateStatistics();
        saveDataToStorage();
        closeInputModal();
        showNotification('Data berhasil disimpan!', 'success');
      }
    } else showNotification('Mohon lengkapi semua field!', 'error');
  }
});

/* ===========================
   Quick Input Mode
   =========================== */
function quickInputMode() {
  document.getElementById('quickInputModal')?.classList.remove('hidden');
  populateQuickInputTable();
}
function closeQuickInputModal() { document.getElementById('quickInputModal')?.classList.add('hidden'); }
function populateQuickInputTable() {
  const tbody = document.getElementById('quickInputTableBody');
  if (!tbody) return;
  const selectedUnit = document.getElementById('quickUnitSelect')?.value || 'unit1';
  const selectedTime = document.getElementById('quickTimeSelect')?.value || '0930';
  tbody.innerHTML = '';
  logsheetData.forEach(item => {
    if (!item.parameter) return;
    const currentValue = item[selectedUnit]?.[selectedTime] ?? '';
    const isValid = validateValue(currentValue, item.range, item.unit);
    const statusClass = currentValue === '' ? 'bg-gray-100' : (isValid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800');
    const statusText = currentValue === '' ? 'Belum diisi' : (isValid ? '‚úÖ Normal' : '‚ö†Ô∏è Di luar range');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="border border-gray-300 p-2 text-center">${item.no}</td>
      <td class="border border-gray-300 p-2">${item.parameter}</td>
      <td class="border border-gray-300 p-2 text-center">${item.unit}</td>
      <td class="border border-gray-300 p-2 text-xs">${item.range}</td>
      <td class="border border-gray-300 p-2 text-center">
        <input type="number" step="0.1" value="${currentValue ?? ''}"
          data-param="${item.no}" data-unit="${selectedUnit}" data-time="${selectedTime}"
          class="w-full text-center border-0 bg-transparent focus:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1"
          onkeydown="handleQuickInputKeydown(event)" onblur="updateQuickInputValue(this)">
      </td>
      <td class="border border-gray-300 p-2 text-center">
        <span class="px-2 py-1 rounded text-xs ${statusClass}">${statusText}</span>
      </td>`;
    tbody.appendChild(row);
  });
}
function handleQuickInputKeydown(event) {
  if (event.key === 'Enter') { updateQuickInputValue(event.target); event.target.blur(); }
  else if (event.key === 'Escape') { event.target.blur(); }
}
function updateQuickInputValue(input) {
  const paramNo = input.dataset.param;
  const unit = input.dataset.unit;
  const time = input.dataset.time;
  const raw = input.value;
  const value = raw === '' ? '' : parseFloat(raw);
  const item = logsheetData.find(i => i.no == paramNo);
  if (!item) return;
  item[unit][time] = raw === '' ? '' : (isNaN(value) ? raw : value);
  saveDataToStorage();
  // update status cell
  const row = input.closest('tr');
  const span = row?.querySelector('td:last-child span');
  const valid = validateValue(item[unit][time], item.range, item.unit);
  if (span) {
    if (item[unit][time] === '') { span.className = 'px-2 py-1 rounded text-xs bg-gray-100'; span.textContent = 'Belum diisi'; }
    else if (valid) { span.className = 'px-2 py-1 rounded text-xs bg-green-100 text-green-800'; span.textContent = '‚úÖ Normal'; }
    else { span.className = 'px-2 py-1 rounded text-xs bg-red-100 text-red-800'; span.textContent = '‚ö†Ô∏è Di luar range'; }
  }
}
function saveAllQuickInput() {
  populateLogsheetTable();
  updateStatistics();
  showNotification('Semua data berhasil disimpan!', 'success');
}
document.getElementById('quickUnitSelect')?.addEventListener('change', populateQuickInputTable);
document.getElementById('quickTimeSelect')?.addEventListener('change', populateQuickInputTable);

/* ===========================
   Misc utilities and buttons
   =========================== */
function refreshData() {
  updateDateTime();
  populateLogsheetTable();
  updateStatistics();
  showNotification('Data berhasil diperbarui!', 'success');
}
function printLogsheet(){ window.print(); }

/* ===========================
   Copy from previous day
   =========================== */
function copyFromPreviousDay(){
  const currentDate = document.getElementById('dateSelect')?.value;
  if (!currentDate) return;
  const prev = new Date(currentDate); prev.setDate(prev.getDate() - 1);
  const prevKey = `logsheet_chiller_${prev.toISOString().slice(0,10)}`;
  const raw = localStorage.getItem(prevKey);
  if (!raw) { showNotification(`Tidak ada data untuk tanggal ${prev.toISOString().slice(0,10)}`,'error'); return; }
  try {
    const parsed = JSON.parse(raw);
    const arr = parsed.data || parsed;
    arr.forEach((s,i) => {
      if (!logsheetData[i]) return;
      // copy only some params if you prefer; here we copy everything
      logsheetData[i].unit1 = s.unit1 || logsheetData[i].unit1;
      logsheetData[i].unit2 = s.unit2 || logsheetData[i].unit2;
      logsheetData[i].unit3 = s.unit3 || logsheetData[i].unit3;
    });
    populateLogsheetTable();
    saveDataToStorage();
    showNotification('Data template dari kemarin berhasil disalin!','success');
  } catch (e) { console.error(e); showNotification('Error copying previous day', 'error'); }
}

/* ===========================
   Export to Excel (basic) - uses SheetJS (xlsx) already included
   =========================== */
function exportLogsheet() {
  const headers = [["No","Description","Parameter","Unit","Range",
    "Unit1_09:30","Unit1_12:00","Unit1_15:00","Unit1_18:00","Unit1_21:00",
    "Unit2_09:30","Unit2_12:00","Unit2_15:00","Unit2_18:00","Unit2_21:00",
    "Unit3_09:30","Unit3_12:00","Unit3_15:00","Unit3_18:00","Unit3_21:00"]];
  const rows = logsheetData.map(it => [
    it.no, it.description, it.parameter, it.unit, it.range,
    it.unit1["0930"], it.unit1["1200"], it.unit1["1500"], it.unit1["1800"], it.unit1["2100"],
    it.unit2["0930"], it.unit2["1200"], it.unit2["1500"], it.unit2["1800"], it.unit2["2100"],
    it.unit3["0930"], it.unit3["1200"], it.unit3["1500"], it.unit3["1800"], it.unit3["2100"]
  ]);
  const ws = XLSX.utils.aoa_to_sheet([...headers, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data Logsheet");
  const date = document.getElementById('dateSelect')?.value || new Date().toISOString().slice(0,10);
  XLSX.writeFile(wb, `Logsheet_Chiller_${date}.xlsx`);
  showNotification('‚úÖ Logsheet berhasil diexport!', 'success');
}

/* ===========================
   Export monthly - reads localStorage keys for month
   =========================== */
function exportMonthlyLogsheet() {
  const dateVal = document.getElementById('dateSelect')?.value;
  if (!dateVal) { showNotification('Pilih tanggal terlebih dahulu','error'); return; }
  const month = dateVal.slice(0,7); // yyyy-mm
  const keys = Object.keys(localStorage).filter(k => k.startsWith(`logsheet_chiller_${month}`));
  if (!keys.length) { showNotification(`Tidak ada data bulan ${month}`,'error'); return; }
  const wb = XLSX.utils.book_new();
  keys.sort().forEach(k => {
    const raw = localStorage.getItem(k);
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      const arr = parsed.data || parsed;
      const headers = [["No","Description","Parameter","Unit","Range",
        "Unit1_09:30","Unit1_12:00","Unit1_15:00","Unit1_18:00","Unit1_21:00",
        "Unit2_09:30","Unit2_12:00","Unit2_15:00","Unit2_18:00","Unit2_21:00",
        "Unit3_09:30","Unit3_12:00","Unit3_15:00","Unit3_18:00","Unit3_21:00"]];
      const rows = arr.map(it => [
        it.no, it.description, it.parameter, it.unit, it.range,
        it.unit1["0930"], it.unit1["1200"], it.unit1["1500"], it.unit1["1800"], it.unit1["2100"],
        it.unit2["0930"], it.unit2["1200"], it.unit2["1500"], it.unit2["1800"], it.unit2["2100"],
        it.unit3["0930"], it.unit3["1200"], it.unit3["1500"], it.unit3["1800"], it.unit3["2100"]
      ]);
      const ws = XLSX.utils.aoa_to_sheet([...headers, ...rows]);
      const sheetName = k.replace('logsheet_chiller_','');
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
    } catch (e) { console.error(e); }
  });
  XLSX.writeFile(wb, `Logsheet_Chiller_${month}.xlsx`);
  showNotification('‚úÖ Export bulanan selesai!', 'success');
}

/* ===========================
   Backup / Import functions
   =========================== */
function backupAllData() {
  const keys = Object.keys(localStorage).filter(k => k.startsWith('logsheet_chiller_'));
  const staffKeys = Object.keys(localStorage).filter(k => k.startsWith('staff_data_'));
  const data = {}, staff = {};
  keys.forEach(k => data[k] = localStorage.getItem(k));
  staffKeys.forEach(k => staff[k] = localStorage.getItem(k));
  const backup = { version:'2.0', timestamp: new Date().toISOString(), data, staff };
  const blob = new Blob([JSON.stringify(backup,null,2)], { type:'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `Backup_Logsheet_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  showNotification('Backup selesai!', 'success');
}
function importBackupData() {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = '.json';
  input.onchange = e => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const parsed = JSON.parse(ev.target.result);
        if (parsed.data) {
          Object.keys(parsed.data).forEach(k => localStorage.setItem(k, parsed.data[k]));
        }
        if (parsed.staff) {
          Object.keys(parsed.staff).forEach(k => localStorage.setItem(k, parsed.staff[k]));
        }
        const date = document.getElementById('dateSelect')?.value;
        if (date) { loadDataForDate(date); loadStaffData(date); }
        showNotification('Import berhasil!', 'success');
      } catch (err) { showNotification('Format file backup tidak valid','error'); }
    };
    reader.readAsText(f);
  };
  input.click();
}

/* ===========================
   Generate daily report (text file)
   =========================== */
function generateDailyReport() {
  const date = document.getElementById('dateSelect')?.value;
  if (!date) { showNotification('Pilih tanggal dulu','error'); return; }
  let total = 0, filled = 0, out = 0;
  logsheetData.forEach(item => {
    if (!item.parameter) return;
    ['unit1','unit2','unit3'].forEach(u => ['0930','1200','1500','1800','2100'].forEach(t => {
      total++;
      const v = item[u][t];
      if (v !== '') {
        filled++;
        if (!validateValue(v, item.range, item.unit)) out++;
      }
    }));
  });
  const report = [
    `LAPORAN HARIAN LOGSHEET - ${new Date(date).toLocaleDateString('id-ID')}`,
    `Total Parameter: ${total}`,
    `Terisi: ${filled}`,
    `Di luar range: ${out}`,
    `` , `PETUGAS:`,
    `Supervisor: ${staffData.supervisor || '-'}`,
    `09:30: ${staffData['0930'] || '-'}`, `12:00: ${staffData['1200'] || '-'}`, `15: ${staffData['1500'] || '-'}`, `18: ${staffData['1800'] || '-'}`, `21: ${staffData['2100'] || '-'}`,
  ].join('\n');
  const blob = new Blob([report], { type:'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `Laporan_Harian_${date}.txt`;
  a.click();
  showNotification('Laporan harian dibuat!', 'success');
}

/* ===========================
   Date display & initialization
   =========================== */
function updateDateDisplay() {
  const dateInput = document.getElementById('dateSelect');
  if (!dateInput) return;
  const d = new Date(dateInput.value);
  if (!isNaN(d)) {
    document.getElementById('currentDate').textContent = d.toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });
  }
  loadDataForDate(dateInput.value);
  loadStaffData(dateInput.value);
  loadLastSaveTime();
  populateParameterSelect();
}

/* Initialize on DOM ready (single entrypoint) */
function updateDateTime() {
  const now = new Date();
  const curDateEl = document.getElementById('currentDate');
  if (curDateEl) curDateEl.textContent = now.toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });
  const lastUpdate = document.getElementById('lastUpdate');
  if (lastUpdate) lastUpdate.textContent = now.toLocaleTimeString('id-ID', {hour:'2-digit',minute:'2-digit'}) + ' WIB';
}
function initializeLogsheet() {
  populateParameterSelect();
  loadLastSaveTime();
  const dateVal = document.getElementById('dateSelect')?.value;
  if (dateVal) { loadDataForDate(dateVal); loadStaffData(dateVal); }
  populateLogsheetTable();
  updateStatistics();
}
window.addEventListener('DOMContentLoaded', () => {
  initializeLogsheet();
  // attach quick input listeners already above; safe to ensure selects exist:
  document.getElementById('quickUnitSelect')?.addEventListener('change', populateQuickInputTable);
  document.getElementById('quickTimeSelect')?.addEventListener('change', populateQuickInputTable);
});

/* Auto refresh & autosave */
setInterval(updateDateTime, 300000); // 5 min
setInterval(() => {
  const last = localStorage.getItem('logsheet_last_save');
  const now = new Date().toISOString();
  if (!last || (new Date(now) - new Date(last)) > 30000) {
    // only save if there is any non-empty value
    const hasData = logsheetData.some(it =>
      Object.values(it.unit1 || {}).some(v => v !== '') ||
      Object.values(it.unit2 || {}).some(v => v !== '') ||
      Object.values(it.unit3 || {}).some(v => v !== '')
    );
    if (hasData) saveDataToStorage();
  }
}, 30000);
</script>

